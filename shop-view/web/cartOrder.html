<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
    <title>结算页</title>

    <link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css"/>
    <link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css"/>
    <script type="text/javascript" src="/js/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
    <script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>
    <script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>
    <script src="js/overall.js"></script>
</head>
<body>
<!--head-->
<div class="top">
    <div class="py-container">
        <div class="shortcut">
            <ul class="fl">
                <li class="f-item">品优购欢迎您！</li>
                <li class="f-item">请登录　<span><a href="#">免费注册</a></span></li>
            </ul>
            <ul class="fr">
                <li class="f-item">我的订单</li>
                <li class="f-item space"></li>
                <li class="f-item">我的品优购</li>
                <li class="f-item space"></li>
                <li class="f-item">品优购会员</li>
                <li class="f-item space"></li>
                <li class="f-item">企业采购</li>
                <li class="f-item space"></li>
                <li class="f-item">关注品优购</li>
                <li class="f-item space"></li>
                <li class="f-item">客户服务</li>
                <li class="f-item space"></li>
                <li class="f-item">网站导航</li>
            </ul>
        </div>
    </div>
</div>
<div class="cart py-container">
    <!--logoArea-->
    <div class="logoArea">
        <div class="fl logo"><span class="title">结算页</span></div>
        <div class="fr search">
            <form class="sui-form form-inline">
                <div class="input-append">
                    <input type="text" type="text" class="input-error input-xxlarge" placeholder="品优购自营"/>
                    <button class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>
                </div>
            </form>
        </div>
    </div>
    <!--主内容-->
    <div class="checkout py-container">
        <div class="checkout-tit">
            <h4 class="tit-txt">填写并核对订单信息</h4>
        </div>
        <div class="checkout-steps">
            <!--收件人信息-->
            <div class="step-tit">
                <h5>收件人信息<span><a data-toggle="modal" data-target=".edit" data-keyboard="false"
                                  class="newadd">新增收货地址</a></span></h5>
            </div>
            <div class="step-cont">
                <div class="addressInfo">
                    <ul class="addr-detail">
                        <li class="addr-item" id="areaDiv">

                        </li>
                    </ul>
                    <!--添加地址-->
                    <!-- 增加-->
                    <div tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade edit">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×
                                    </button>
                                    <h4 id="myModalLabel" class="modal-title">添加收货地址</h4>
                                </div>
                                <div class="modal-body">
                                    <form action="" class="sui-form form-horizontal">
                                        <div class="control-group">
                                            <label class="control-label">收货人：</label>
                                            <div class="controls">
                                                <input type="text" id="userName" class="input-medium">
                                            </div>
                                        </div>

                                        <div class="control-group">
                                            <label class="control-label">详细地址：</label>
                                            <div class="controls">
                                                <input type="text" id="areaName" class="input-large">
                                            </div>
                                        </div>
                                        <div class="control-group">
                                            <label class="control-label">联系电话：</label>
                                            <div class="controls">
                                                <input type="text" id="phone" class="input-medium">
                                            </div>
                                        </div>
                                        <div class="control-group">
                                            <label class="control-label">邮箱：</label>
                                            <div class="controls">
                                                <input type="text" id="email" class="input-medium">
                                            </div>
                                        </div>
                                        <div class="control-group">
                                            <label class="control-label">地址别名：</label>
                                            <div class="controls">
                                                <input type="text" id="aliasName" class="input-medium">
                                            </div>
                                        </div>
                                        <div class="control-group">
                                            <label class="control-label">是否设为默认地址：</label>
                                            <div class="controls">
                                                <input type="radio" name="defaultArea" value="1" class="input-medium">设为默认
                                                <input type="radio" name="defaultArea" value="2" checked="checked"
                                                       class="input-medium">不设置
                                            </div>
                                        </div>

                                    </form>


                                </div>
                                <div class="modal-footer">
                                    <button type="button" data-ok="modal" onclick="addConsignee()"
                                            class="sui-btn btn-primary btn-large">确定
                                    </button>
                                    <button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large">
                                        取消
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--确认地址-->
                </div>
                <input id="areaId" type="hidden">
                <div class="hr"></div>

            </div><!--收件人地址-->
            <div class="hr"></div>
            <!--支付和送货-->
            <div class="payshipInfo">
                <div class="step-tit">
                    <h5>支付方式</h5>
                </div>
                <div class="step-cont">
                    <ul class="payType">
                        <li class="selected">微信付款<span title="点击取消选择" onclick="payType(1)"></span></li>
                        <li onclick="payType(2)">货到付款<span title="点击取消选择"></span></li>
                    </ul>
                </div>
                <input id="payType" type="hidden" value="1">
                <div class="hr"></div>
                <div class="step-tit">
                    <h5>送货清单</h5>
                </div>
                <div class="step-cont">
                    <ul class="send-detail" id="productDiv">

                    </ul>
                </div>
                <div class="hr"></div>
            </div>
            <div class="linkInfo">
                <div class="step-tit">
                    <h5>发票信息</h5>
                </div>
                <div class="step-cont">
                    <span>普通发票（电子）</span>
                    <span>个人</span>
                    <span>明细</span>
                </div>
            </div>
            <div class="cardInfo">
                <div class="step-tit">
                    <h5>使用优惠/抵用</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="order-summary" id="jinDiv">

    </div>
    <div class="clearfix trade">
        <div class="fc-price">应付金额:　<span class="price" id="totalPrice"0￥</span></div>
        <div class="fc-receiverInfo" id="consigneeArea"></div>
    </div><!--最下面-->
    <div class="submit">
        <a class="sui-btn btn-danger btn-xlarge" id="subbut" href="javascript:;" onclick="submitOrder()">提交订单</a>
    </div>
</div>
<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
    <div class="py-container">
        <div class="footlink">
            <div class="Mod-service">
                <ul class="Mod-Service-list">
                    <li class="grid-service-item intro  intro1">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro2">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro  intro3">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro4">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro intro5">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                </ul>
            </div>
            <div class="clearfix Mod-list">
                <div class="yui3-g">
                    <div class="yui3-u-1-6">
                        <h4>购物指南</h4>
                        <ul class="unstyled">
                            <li>购物流程</li>
                            <li>会员介绍</li>
                            <li>生活旅行/团购</li>
                            <li>常见问题</li>
                            <li>购物指南</li>
                        </ul>

                    </div>
                    <div class="yui3-u-1-6">
                        <h4>配送方式</h4>
                        <ul class="unstyled">
                            <li>上门自提</li>
                            <li>211限时达</li>
                            <li>配送服务查询</li>
                            <li>配送费收取标准</li>
                            <li>海外配送</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>支付方式</h4>
                        <ul class="unstyled">
                            <li>货到付款</li>
                            <li>在线支付</li>
                            <li>分期付款</li>
                            <li>邮局汇款</li>
                            <li>公司转账</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>售后服务</h4>
                        <ul class="unstyled">
                            <li>售后政策</li>
                            <li>价格保护</li>
                            <li>退款说明</li>
                            <li>返修/退换货</li>
                            <li>取消订单</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>特色服务</h4>
                        <ul class="unstyled">
                            <li>夺宝岛</li>
                            <li>DIY装机</li>
                            <li>延保服务</li>
                            <li>品优购E卡</li>
                            <li>品优购通信</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                    </div>
                </div>
            </div>
            <div class="Mod-copyright">
                <ul class="helpLink">
                    <li>关于我们<span class="space"></span></li>
                    <li>联系我们<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>商家入驻<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!--页面底部END-->

<div id="area_Model" style="display: none">
    <div>
        <div class="con name " id="area_select##id##" onclick="select('##id##')"><a href="javascript:;">##name##<span
                title="点击取消选择"> &nbsp; </span></a></div>
        <div class="con address" id="defult##id##">##name## ##area## ##areaName## <span>##phone##</span>

        </div>
        <div class="clearfix"></div>
        <input type="hidden" id="shou##id##" value="寄送至:##area## ##areaName## 收货人：##name## ##phone##">
    </div>
</div>                    <!--模板-->

<div id="productModel" style="display: none">                                                <!--模板-->
    <li>
        <div class="sendGoods">

            <ul class="yui3-g">
                <li class="yui3-u-1-6">
                    <span><img src="##photoPath##" style="height: 90px"/></span>
                </li>
                <li class="yui3-u-7-12">
                    <div class="desc">##productName## 64G 玫瑰金色 移动联通电信4G手机硅胶透明防摔软壳 本色系列</div>
                    <div class="seven">7天无理由退货</div>
                </li>
                <li class="yui3-u-1-12">
                    <div class="price">￥##price##</div>
                </li>
                <li class="yui3-u-1-12">
                    <div class="num">X##count##</div>
                </li>
                <li class="yui3-u-1-12">
                    <div class="exit">有货</div>
                </li>
            </ul>
        </div>
    </li>
</div>

<div style="display: none" id="jinModel">
    <div class="static fr">
        <div class="list">
            <span><i class="number">##totalCount##</i>件商品，总商品金额</span>
            <em class="allprice">¥##totalPrice##</em>
        </div>
        <div class="list">
            <span>返现：</span>
            <em class="money">0.00</em>
        </div>
        <div class="list">
            <span>运费：</span>
            <em class="transport">0.00</em>
        </div>
    </div>
</div>

</body>
<script>

    var aaa = "";
    window.onload = function () {
        queryDirection();
        queryCart();
    }

    function queryDirection() {
        $.post({
            url: "http://localhost:8085/order/queryDirection",
            dataType: "json",
            async: false,
            success: function (data) {
                //alert(JSON.stringify(data))
                if (data.status == 200) {
                    $(data.data).each(function () {
                        var areaModel = $("#area_Model").html().replace(/##name##/g, this.name).replace(/##area##/g, this.area).replace(/##areaName##/g, this.areaName).replace(/##phone##/g, this.phone).replace(/##id##/g, this.id);

                        $("#areaDiv").append(areaModel);
                        if (this.defaultArea == 1) {
                            $("#areaId").val(this.id)
                            $("#area_select" + this.id).attr("class", "con name selected")
                            $("#defult" + this.id).append("<span class=\"base\">默认地址</span>");
                            $("#consigneeArea").html("寄送至:" + this.area + " " + this.areaName + " 收货人：" + this.name + " " + this.phone + "")
                        }
                    })

                }
            }
        })
    }

    function select(id) {
        $("#areaDiv div").removeClass("selected");
        $("#area_select" + id).addClass("selected");
        var val = $("#shou" + id).val();
        $("#consigneeArea").html(val)
        var consigneeId = $("#areaId").val(id);
    }

    function queryCart() {
        if (loginStatus) {
            $.post({
                url: "http://localhost:8085/cart/queryCart",
                dataType: "json",
                success: function (data) {
                    $("#carDiv").html("");
                    if (data.status == 200) {
                        $(data.data.list).each(function () {
                            var carModel = $("#productModel").html().replace(/##photoPath##/g, "http://192.168.216.136:8000/" + this.photoPath).replace(/##productName##/g, this.productName).replace(/##price##/g, this.price).replace(/##count##/g, this.count).replace(/##countPrice##/g, this.countPrice).replace(/##productId##/g, this.productId);
                            $("#productDiv").append(carModel);
                        })
                        var shopCarModel = $("#jinModel").html().replace(/##totalCount##/g, data.data.totalCount).replace(/##totalPrice##/g, data.data.totalPrice);
                        $("#jinDiv").html(shopCarModel);
                        $("#totalPrice").html("￥" + data.data.totalPrice)
                    } else {
                        var str = " <h2> <div style='text-align:center'>去<a href='index.html'>首页</a>选商品</div></h2> "
                        $("#productDiv").html(str)
                        $("#subbut").attr("disabled", "disabled");
                        $("#subbut").attr("onclick", "");
                    }
                }
            })
        }
    }


    function submitOrder() {
        var consigneeId = $("#areaId").val();
        var payType = $("#payType").val();

        $.post({
            url: "http://localhost:8085/order/sendOrder",
            data: {"consigneeId": consigneeId, "payType": payType},
            beforeSend:function(xhr) {
                var v_fhToken =window.localStorage.getItem(Config.COOKIE_NAME);
                if (v_fhToken) {
                    xhr.setRequestHeader(Config.HEADER_NAME, v_fhToken);
                }
                xhr.setRequestHeader(Config.TOKEN_NAME, mtoken);
            },
            dataType: "json",
            success: function (data) {
                if (data.status == 200) {
                    var str = "";
                    if (data.data.length > 0) {
                        $(data.data).each(function () {
                            str += this.productName + ",";
                        });
                        alert(str + "商品库存不足！")
                        location.href = "/pay.html"
                    } else {
                        location.href = "/pay.html"
                    }
                } else {
                    alert(data.msg)
                }
            }

        })
    }

    function payType(payType) {
        $("#payType").val(payType);
    }

    function addConsignee() {
        var userName = $("#userName").val();
        var areaName = $("#areaName").val();
        var phone = $("#phone").val();
        var email = $("#email").val();
        var aliasName = $("#aliasName").val();
        var defaultArea = $("[name='defaultArea']:checked").val()

    $.post({
        url:"http://localhost:8085/order/addConsigneeinfo",
        data:{"name":userName,"area":areaName,"phone":phone,"email":email,"areaName":aliasName,"defaultArea":defaultArea},
        dataType:"json",
        success:function (data) {
            if (data.status == 200) {
                queryCart();
            }
        }
    })
    }
</script>

</html>